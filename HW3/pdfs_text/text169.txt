An Inﬁnite Hidden Markov Model With Similarity-Biased Transitions

Colin Reimer Dawson 1 Chaofan Huang 1 Clayton T. Morrison 2

Abstract

We describe a generalization of the Hierarchical
Dirichlet Process Hidden Markov Model (HDP-
HMM) which is able to encode prior informa-
tion that state transitions are more likely be-
tween “nearby” states. This is accomplished
by deﬁning a similarity function on the state
space and scaling transition probabilities by pair-
wise similarities, thereby inducing correlations
among the transition distributions. We present
an augmented data representation of the model
as a Markov Jump Process in which: (1) some
jump attempts fail, and (2) the probability of suc-
cess is proportional to the similarity between the
source and destination states. This augmenta-
tion restores conditional conjugacy and admits a
simple Gibbs sampler. We evaluate the model
and inference method on a speaker diarization
task and a “harmonic parsing” task using four-
part chorale data, as well as on several synthetic
datasets, achieving favorable comparisons to ex-
isting models.

1. Introduction and Background

The hierarchical Dirichlet process hidden Markov model
(HDP-HMM) (Beal et al., 2001; Teh et al., 2006) is a
Bayesian model for time series data that generalizes the
conventional hidden Markov Model to allow a countably
inﬁnite state space. The hierarchical structure ensures that,
despite the inﬁnite state space, a common set of destination
states will be reachable with positive probability from each
source state. The HDP-HMM can be characterized by the
following generative process.

indexed by j, has parameters, θj, drawn
Each state,
from a base measure, H. A top-level sequence of state
weights, β = (β1, β2, . . . ), is drawn by iteratively break-

1 Oberlin College, Oberlin, OH, USA 2The University of Ari-
zona, Tucson, AZ, USA. Correspondence to: Colin Reimer Daw-
son <cdawson@oberlin.edu>.

Proceedings of the 34 th International Conference on Machine
Learning, Sydney, Australia, PMLR 70, 2017. Copyright 2017
by the author(s).

ing a “stick” off of the remaining weight according to a
Beta (1, γ) distribution. The parameter γ > 0 is known
as the concentration parameter and governs how quickly
the weights tend to decay, with large γ corresponding to
slow decay, and hence more weights needed before a given
cumulative weight is reached. This stick-breaking process
is denoted by GEM (Ewens, 1990; Sethuraman, 1994) for
Grifﬁths, Engen and McCloskey. We thus have a discrete
probability measure, G0, with weights βj at locations θj,
j = 1, 2, . . . , deﬁned by

i.i.d.∼ H

θj

β ∼ GEM(γ).

(1)

G0 drawn in this way is a Dirichlet Process (DP) random
measure with concentration γ and base measure H.

The actual transition distribution, πj, from state j, is drawn
from another DP with concentration α and base measure
G0:

πj

i.i.d.∼ DP(αG0)

j = 0, 1, 2, . . .

(2)

where π0 represents the initial distribution. The hidden
state sequence, z1, z2, . . . zT is then generated according to
z1 | π0 ∼ Cat(π0), and

zt | zt−1, πzt−1 ∼ Cat(πzt−1 )

t = 1, 2, . . . , T

(3)

Finally, the emission distribution for state j is a function of
θj, so that observation yt is drawn according to

yt | zt, θzt ∼ F (θzt)

(4)

A shortcoming of the HDP prior on the transition matrix is
that it does not use the fact that the source and destination
states are the same set: that is, each πj has a special ele-
ment which corresponds to a self-transition. In the HDP-
HMM, however, self-transitions are no more likely a priori
than transitions to any other state. The Sticky HDP-HMM
(Fox et al., 2008) addresses this issue by adding an extra
mass κ at location j to the base measure of the DP that
generates πj. That is, (2) is replaced by

πj ∼ DP(αG0 + κδθj ).

(5)

An alternative approach that treats self-transitions as spe-
is the HDP Hidden Semi-Markov Model (HDP-
cial
HSMM; Johnson & Willsky (2013)), wherein state dura-
tion distributions are modeled separately, and ordinary self-
transitions are ruled out. However, while both of these

An Inﬁnite HMM With Similarity-Biased Transitions

models have the ability to privilege self-transitions, they
contain no notion of similarity for pairs of states that are
not identical: in both cases, when the transition matrix is
integrated out, the prior probability of transitioning to state
j(cid:48) depends only on the top-level stick weight associated
with state j(cid:48), and not on the identity or parameters of the
previous state j.

The two main contributions of this paper are (1) a general-
ization of the HDP-HMM, which we call the HDP-HMM
with local transitions (HDP-HMM-LT) that allows for a ge-
ometric structure to be deﬁned on the latent state space, so
that “nearby” states are a priori more likely to have transi-
tions between them, and (2) a simple Gibbs sampling algo-
rithm for this model. The “LT” property is introduced by
elementwise rescaling and then renormalizing of the HDP
transition matrix. Two versions of the similarity structure
are illustrated: in one case, two states are similar to the ex-
tent that their emission distributions are similar. In another,
the similarity structure is inferred separately. In both cases,
we give augmented data representations that restore condi-
tional conjugacy and thus allow a simple Gibbs sampling
algorithm to be used for inference.

A rescaling and renormalization approach similar to the
one used in the HDP-HMM-LT is used by Paisley et al.
(2012) to deﬁne their Discrete Inﬁnite Logistic Normal
(DILN) model, an instance of a correlated random measure
(Ranganath & Blei, 2016), in the setting of topic modeling.
There, however, the contexts and the mixture components
(topics) are distinct sets, and there is no notion of tem-
poral dependence. Zhu et al. (2016) developed an HMM
based directly on the DILN model1. Both Paisley et al. and
Zhu et al. employ variational approximations, whereas we
present a Gibbs sampler, which converges asymptotically
to the true posterior. We discuss additional differences be-
tween our model and the DILN-HMM in Sec. 2.2.

One class of application in which it is useful to incorporate
a notion of locality occurs when the latent state sequence
consists of several parallel chains, so that the global state
changes incrementally, but where these increments are not
independent across chains. Factorial HMMs (Ghahramani
et al., 1997) are commonly used in this setting, but this ig-
nores dependence among chains, and hence may do poorly
when some combinations of states are much more probable
than suggested by the chain-wise dynamics.

Another setting where the LT property is useful is when
there is a notion of state geometry that licenses syllogisms:
e.g., if A frequently leads to B and C and B frequently leads
to D and E, then it may be sensible to infer that A and C
may lead to D and E as well. This property is arguably

1We thank an anonymous ICML reviewer for bringing this pa-

per to our attention.

present in musical harmony, where consecutive chords are
often (near-)neighbors in the “circle of ﬁfths”, and small
steps along the circle are more common than large ones.

The paper is structured as follows: In section 2 we de-
In section 3, we develop a Gibbs sam-
ﬁne the model.
pling algorithm based on an augmented data representa-
tion, which we call the Markov Jump Process with Failed
Transitions (MJP-FT). In section 4 we test two versions
of the model: one on a speaker diarization task in which
the speakers are inter-dependent, and another on a four-
part chorale corpus, demonstrating performance improve-
ments over state-of-the-art models when “local transitions”
are more common in the data. Using sythetic data from
an HDP-HMM, we show that the LT variant can learn
not to use its similarity bias when the data does not sup-
port it. Finally, in section 5, we conclude and discuss
the relationships between the HDP-HMM-LT and existing
HMM variants. Code and additional details are available at
http://colindawson.net/hdp-hmm-lt/

2. An HDP-HMM With Local Transitions

We wish to add to the transition model the concept of a
transition to a “nearby” state, where transitions between
states j and j(cid:48) are more likely a priori to the extent that
In order to
they are “nearby” in some similarity space.
accomplish this, we ﬁrst consider an alternative construc-
tion of the transition distributions, based on the Normal-
ized Gamma Process representation of the DP (Ishwaran &
Zarepour, 2002; Ferguson, 1973).

2.1. A Normalized Gamma Process representation of

the HDP-HMM

The Dirichlet Process is an instance of a normalized com-
pletely random measure (Kingman, 1967; Ferguson, 1973),
that can be deﬁned as G = (cid:80)∞

k=1 ˜πkδθk , where

πk

ind.∼ Gamma(αβk, 1) T =

πk

˜πk =

(6)

∞
(cid:88)

k=1

πk
T

,

δθ is a measure assigning 1 to sets if they contain θ and 0
otherwise, and subject to the constraint that (cid:80)
k≥1 βk = 1
and 0 < α < ∞. It has been shown (Ferguson, 1973; Pais-
ley et al., 2012; Favaro et al., 2013) that the normalization
constant T is positive and ﬁnite almost surely, and that G is
distributed as a DP with base measure G0 = (cid:80)∞
k=1 βkδθk .
If we draw β = (β1, β2, . . . ) from the GEM(γ) stick-
breaking process, draw an i.i.d. sequence of θk from a base
measure H, and then draw an i.i.d. sequence of random
measures, {Gj}, j = 1, 2, . . . , from the above process, this
deﬁnes a Hierarchical Dirichlet Process (HDP). If each Gj
is associated with the hidden states of an HMM, π is the
inﬁnite matrix where entry πjj(cid:48) is the j(cid:48)th mass associated

An Inﬁnite HMM With Similarity-Biased Transitions

with the jth random measure, and Tj is the sum of row j,
then we obtain the prior for the HDP-HMM, where

p(zt | zt−1, π) = ˜πzt−1zt = πjj(cid:48)/Tj

(7)

2.2. Promoting “Local” Transitions

In the HDP prior, the rows of the transition matrix are con-
ditionally independent. We wish to relax this assumption,
to incorporate possible prior knowledge that certain pairs of
states are “nearby” in some sense and thus more likely than
others to produce large transition weights between them (in
both directions); that is, transitions are likely to be “lo-
cal”. We accomplish this by associating each latent state
j with a location (cid:96)j in some space Ω, introducing a “sim-
ilarity function” φ : Ω × Ω → (0, 1], and scaling each
element πjj(cid:48) by φjj(cid:48) = φ((cid:96)j, (cid:96)j(cid:48)). For example, we might
wish to deﬁne a (possibly asymmetric) divergence function
d : Ω × Ω → [0, ∞) and set φ((cid:96)j, (cid:96)j) = exp{−d((cid:96)j, (cid:96)j(cid:48))}
so that transitions are less likely the farther apart two states
are. By setting φ ≡ 1, we obtain the standard HDP-HMM.
The DILN-HMM (Zhu et al., 2016), employs a similar
rescaling of transition probabilities via an exponentiated
Gaussian Process, following (Paisley et al., 2012), but the
scaling function must be positive semi-deﬁnite, and in par-
ticular symmetric, whereas in the HDP-HMM-LT, φ need
only take values in (0, 1]. Moreover, the DILN-HMM does
not allow the scales to be tied to other state parameters, and
hence encode an independent notion of similarity.

Letting (cid:96) = ((cid:96)1, (cid:96)2, . . . ), we can replace (6) for j ≥ 1 by

πjj(cid:48) | β, (cid:96) ∼ Gamma(αβj(cid:48), 1), Tj =

πjj(cid:48)φjj(cid:48)

∞
(cid:88)

j(cid:48)=1

(8)

˜πjj(cid:48) = πjj(cid:48)φjj(cid:48)/Tj,

p(zt | zt−1, π, (cid:96)) = ˜πzt−1zt.

Since the φjj(cid:48) are positive and bounded above by 1,

0 < πj1φj1 ≤ Tj ≤

πjj(cid:48) < ∞

(9)

(cid:88)

j(cid:48)

almost surely, where the last inequality carries over from
the original HDP. The prior means of the unnormalized
transition distributions, πj are then proportional (for each
j) to αβφj where φj = (φj1, φj2, . . . ).

The distribution of the latent state sequence z given π and
(cid:96) is now

p(z | π, (cid:96)) =

πzt−1ztφzt−1ztT

−nzt−1·
zt−1

T
(cid:89)

t=1
∞
(cid:89)

j=1

=

T −1
j

π

njj(cid:48)
jj(cid:48) φ

njj(cid:48)
jj(cid:48)

∞
(cid:89)

j(cid:48)=1

where njj(cid:48) = (cid:80)T
t=1 I(zt−1 = j, zt = j(cid:48)) is the num-
ber of transitions from state j to state j(cid:48) in the sequence z

and nj· = (cid:80)
j(cid:48) njj(cid:48) is the total number of visits to state
j. Since Tj is a sum over products of πjj(cid:48) and φjj(cid:48) terms,
the posterior for π is no longer a DP. However, conditional
conjugacy can be restored by a data-augmentation process
with a natural interpretation, which is described next.

2.3. The HDP-HMM-LT as the Marginalization of a
Markov Jump Process with “Failed” Transitions

In this section, we deﬁne a stochastic process that we
call the Markov Jump Process with Failed Transitions
(MJP-FT), from which we obtain the HDP-HMM-LT by
marginalizing over some of the variables. By reinstating
these auxiliary variables, we obtain a simple Gibbs sam-
pling algorithm over the full MJP-FT, which can be used
to sample from the marginal posterior of the variables used
by the HDP-HMM-LT.

Let β, π, (cid:96) and Tj, j = 1, 2, . . . be deﬁned as in the
last section. Consider a continuous-time Markov Process
over the states j = 1, 2, . . . , and suppose that if the pro-
cess makes a jump to state zt at time τt, the next jump,
which is to state zt+1, occurs at time τt + ˜ut, where
˜ut ∼ Exp((cid:80)
j(cid:48) πjj(cid:48)), and p(zt+1 = j(cid:48) | zt = j) ∝ πjj(cid:48),
independent of ˜ut. Note that in this formulation, unlike in
standard formulations of Markov Jump Processes, we are
assuming that self-jumps are possible.

If we only observe the jump sequence z and not the hold-
ing times ˜ut, this is an ordinary Markov chain with tran-
sition matrix row-proportional to π. If we do not observe
the jumps directly, but instead an observation is generated
once per jump from a distribution that depends on the state
being jumped to, then we have an ordinary HMM whose
transition matrix is obtained by normalizing π; that is, we
have the HDP-HMM.

We modify this process as follows. Suppose each jump at-
tempt from state j to state j(cid:48) has probability (1 − φjj(cid:48)) of
failing, in which case no transition occurs and no observa-
tion is generated. Assuming independent failures, the rates
of successful and failed jumps from j to j(cid:48) are πjj(cid:48)φjj(cid:48) and
πjj(cid:48)(1 − φjj(cid:48)), respectively. The probability that the ﬁrst
successful jump is to state j(cid:48) (that is, that zt+1 = j(cid:48)) is
proportional to the rate of successful jump attempts to j(cid:48),
which is πjj(cid:48)φjj(cid:48). Conditioned on zt, the holding time, ˜ut,
is independent of zt+1 and is distributed as Exp(Tzt). We
denote the total time spent in state j by uj = (cid:80)
t:zt=j ˜ut,
where, as the sum of i.i.d. Exponentials,

(10)

uj | z, π, θ ind.∼ Gamma(nj·, Tj)

(11)

During this period there will be qjj(cid:48) failed attempts to jump
to state j(cid:48), where qjj(cid:48) ∼ Poisson(ujπjj(cid:48)(1 − φjj(cid:48))) are in-
dependent. This data augmentation bears some conceptual
similarity to the Geometrically distributed ρ auxiliary vari-
ables introduced to the HDP-HSMM (Johnson & Willsky,

An Inﬁnite HMM With Similarity-Biased Transitions

2013) to restore conditional conjugacy. However, there are
key differences: ﬁrst, ρ measure how many steps the chain
would have remained in state j under Markovian dynam-
ics, whereas our u represents putative continuous holding
times between each transition, and second ρ allows for the
restoration of a zeroed out entry in each row, whereas u al-
lows us to work with unnormalized π entries, avoiding the
need to restore zeroed out entries in the HSMM-LT

Incorporating u = {uj} and Q = {qjj(cid:48)} as augmented
data simpliﬁes the likelihood for π, yielding

p(z,u, Q | π) = p(z | π)p(u | z, π)p(Q | u, π)

(12)

where dependence on (cid:96) has been omitted for conciseness.
After grouping terms and omitting terms that do not depend
on π, this proportional (as a function of π) to

(cid:89)

(cid:89)

j

j(cid:48)

π

njj(cid:48) +qjj(cid:48)
jj(cid:48)

φ

njj(cid:48)
jj(cid:48) (1 − φjj(cid:48))qjj(cid:48) e−πjj(cid:48) uj

(13)

Conveniently, the Tj have canceled, and the exponential
terms involving πjj(cid:48) and φjj(cid:48) in the Gamma and Poisson
distributions of uj and qjj(cid:48) combine to cause φjj(cid:48) to vanish.

2.4. Sticky and Semi-Markov Generalizations

We note that the local transition property of the HDP-
HMM-LT can be combined with the Sticky property of
the Sticky HDP-HMM (Fox et al., 2008), or the non-
geometric duration distributions of the HDP-HSMM (John-
son & Willsky, 2013), to add additional prior weight on
self-transitions. In the former case, no changes to inference
are needed; one can simply add the the extra mass κ to the
shape parameter of the Gamma prior on the πjj, and em-
ploy the same auxiliary variable method used by Fox et al.
to distinguish “Sticky” from “regular” self-transitions. For
the semi-Markov case, we can ﬁx the diagonal elements
of π to zero, and allow Dt observations to be emitted i.i.d.
according to a state-speciﬁc duration distribution, and sam-
ple the latent state sequence using a suitable semi-Markov
message passing algorithm (Johnson & Willsky, 2013). In-
ference for the φ matrix is not affected, since the diag-
onal elements are assumed to be 1. Unlike in the orig-
inal representation of the HDP-HSMM, no further data-
augmentation is needed, as the (continuous) durations u
already account for the normalization of the π.

2.5. Obtaining the Factorial HMM as a Limiting Case

One setting in which a local transition property is desirable
is the case where the latent states encode multiple hidden
features at time t as a vector of categories. Such problems
are often modeled using factorial HMMs (Ghahramani
et al., 1997). In fact, the HDP-HMM-LT yields the factorial
HMM in the limit as α, γ → ∞, ﬁxing each row of π to be

uniform with probability 1, so the dynamics are controlled
entirely by φ. If A(d) is the transition matrix for chain d,
then setting φ((cid:96)j, (cid:96)j(cid:48)) = exp −d((cid:96)j, (cid:96)j(cid:48)) with asymmetric
“divergences” d((cid:96)j, (cid:96)j(cid:48)) = − (cid:80)
) yields the
factorial transition model.

d log(A(d)

(cid:96)jd,(cid:96)j(cid:48) d

2.6. An Inﬁnite Factorial HDP-HMM-LT

Nonparametric extensions of the factorial HMM, such as
the inﬁnite factorial hidden Markov Model (Gael et al.,
2009) and the inﬁnite factorial dynamic model (Valera
et al., 2015), have been developed in recent years by mak-
ing use of the Indian Buffet Process (Ghahramani & Grif-
It would be conceptually
ﬁths, 2005) as a state prior.
straightforward to combine the IBP state prior with the sim-
ilarity bias of the LT model, provided the chosen similarity
function is uniformly bounded above on the space of in-
ﬁnite length binary vectors (for example, take φ(u, v) to
be the exponentiated negative Hamming distance between
u and v). Since the number of differences between two
draws from the IBP is ﬁnite with probability 1, this yields
a reasonable similarity metric.

3. Inference

We develop a Gibbs sampling algorithm based on the MJP-
FT representation described in Sec. 2.3, augmenting the
data with the duration variables u, the failed jump attempt
count matrix, Q, as well as additional auxiliary variables
which we will deﬁne below. In this representation the tran-
sition matrix is not represented directly, but is a determinis-
tic function of the unscaled transition “rate” matrix, π, and
the similarity matrix, φ. The full set of variables is parti-
tioned into blocks: {γ, α, β, π}, {z, u, Q, Λ}, {θ, (cid:96)}, and
{ξ}, where Λ represents a set of auxiliary variables that will
be introduced below, θ represents the emission parameters
(which may be further blocked depending on the speciﬁc
choice of model), and ξ represents additional parameters
such as any free parameters of the similarity function, φ,
and any hyperparameters of the emission distribution.

3.1. Sampling Transition Parameters and

Hyperparameters

The joint posterior over γ, α, β and π given the augmented
data D = (z, u, Q, Λ) will factor as

p(γ,α, β, π | D)

= p(γ | D)p(α | D)p(β | γ, D)p(π | α, β, D)

(14)

We describe these four factors in reverse order.

Sampling π Having used data augmentation to sim-
plify the likelihood for π to the factored conjugate form
in (13), the individual πjj(cid:48) are a posteriori independent

An Inﬁnite HMM With Similarity-Biased Transitions

Gamma(αβj(cid:48) + njj(cid:48) + qjj(cid:48), 1 + uj) distributed.

3.2. Sampling z and the auxiliary variables

Sampling β To enable joint sampling of z, we employ
a weak limit approximation to the HDP (Johnson & Will-
sky, 2013), approximating the stick-breaking process for β
using a ﬁnite Dirichlet distribution with a J components,
where J is larger than we expect to need. Due to the
product-of-Gammas form, we can integrate out π analyt-
ically to obtain the marginal likelihood:

p(β | γ) =

Γ(γ/J)J
Γ(γ)

(cid:89)

γ
J −1
j

β

j

(15)

p(D | β, α) ∝

J
(cid:89)

j=1

(1 + uj)−α (cid:89)

Γ(αβj(cid:48) + njj(cid:48) + qjj(cid:48))
Γ(αβj(cid:48))

j(cid:48)

where we have used the fact that the βj sum to 1 to pull
out terms of the form (1 + uj)−αβj(cid:48) from the inner prod-
uct in the likelihood. Following Teh et al. (2006), we can
introduce auxiliary variables M = {mjj(cid:48)}, with

We sample the hidden state sequence, z, jointly with the
auxiliary variables, which consist of u, Q, M, r and w.
The joint conditional distribution of these variables is de-
ﬁned directly by the generative model:

p(D) = p(z)p(u | z)p(Q | u)p(M | z, Q)p(r | M)p(w | M)

Since we are conditioning on the transition matrix, we
can sample the entire sequence z jointly with the forward-
backward algorithm, as in an ordinary HMM. Since we are
sampling the labels jointly, this step requires O(T J 2) com-
putation per iteration, which is the bottleneck of the infer-
ence algorithm for reasonably large T or J (other updates
are constant in T or in J). Having done this, we can sample
u, Q, M, r and w from their forward distributions. It is also
possible to employ a variant on beam sampling (Van Gael
et al., 2008) to speed up each iteration, at the cost of slower
mixing, but we did not use this variant here.

p(mjj(cid:48) | βj(cid:48), α, D)

ind

∝ snjj(cid:48) +qjj(cid:48) ,mjj(cid:48) αmjj(cid:48) β

mjj(cid:48)
j(cid:48)

(16)

3.3. Sampling state and emission parameters

for integer mjj(cid:48) ranging between 0 and njj(cid:48) + qjj(cid:48), where
sn,m is an unsigned Stirling number of the ﬁrst kind. The
normalizing constant in this distribution cancels the ra-
tio of Gamma functions in the β likelihood, so, letting
m·j(cid:48) = (cid:80)
j(cid:48) m·j(cid:48), the posterior for
(the truncated) β is a Dirichlet whose jth mass parameter
is γ

j mjj(cid:48) and m·· = (cid:80)

J + m·j.

Depending on the application, the locations (cid:96) may or may
not depend on the emission parameters, θ. If not, sampling
θ conditional on z is unchanged from the HDP-HMM.
There is no general-purpose method for sampling (cid:96), or for
sampling θ in the dependent case, due to the dependence
on the form of φ and on the emission model, but speciﬁc
instances are illustrated in the experiments below.

Sampling Concentration Parameters
into D, we can integrate out β to obtain

Incorporating M

4. Experiments

p(D | α, γ) ∝ αm·· e− (cid:80)
Γ(γ)
Γ(γ + m··)

j(cid:48)(cid:48) log(1+uj(cid:48)(cid:48) )α

Γ( γ

(cid:89)

J + m·j)
Γ( γ
J )

×

j

(17)

Assuming that α and γ have Gamma priors with shape and
rate parameters aα, bα and aγ, bγ, then

α | D ∼ Gamma(aα + m··, bα +

log(1 + uj)).

(18)

(cid:88)

j

To simplify the likelihood for γ, we can introduce a ﬁ-
nal set of auxiliary variables, r = (r1, . . . , rJ ), rj(cid:48) ∈
{0, . . . , m·j(cid:48)} and w ∈ (0, 1) with the following distribu-
tions:

p(rj(cid:48) = r | m·j(cid:48), γ) ∝ s(m·j(cid:48), r)

p(w | m··γ) ∝ wγ−1(1 − w)m··−1

(cid:17)r

(cid:16) γ
J

(19)

(20)

The normalizing constants are ratios of Gamma functions,
which cancel those in (17), so that

The parameter space for the hidden states, the associated
prior H on θ, and the similarity function φ, is application-
speciﬁc; we consider here two cases. The ﬁrst is a speaker-
diarization task, where each state consists of a ﬁnite D-
dimensional binary vector whose entries indicate which
speakers are currently speaking.
In this experiment, the
state vectors both determine the pairwise similarities and
partially determine the emission distributions via a linear-
Gaussian model. In the second experiment, the data con-
sists of Bach chorales, and the latent states can be thought
of as harmonic contexts. There, the components of the
states that govern similarities are modeled as independent
of the emission distributions, which are categorical distri-
butions over four-voice chords.

4.1. Cocktail Party

The Data The data was constructed using audio signals
collected from the PASCAL 1st Speech Separation Chal-
lenge2. The underlying signal consisted of D = 16 speaker
channels recorded at each of T = 2000 time steps, with the

γ | D, r, w ∼ Gamma(aγ + r·, bγ − log(w))

(21)

2http://laslab.org/SpeechSeparationChallenge/

An Inﬁnite HMM With Similarity-Biased Transitions

resulting T × D signal matrix, denoted by θ∗, mapped to
K = 12 microphone channels via a weight matrix, W. The
16 speakers were grouped into 4 conversational groups of
4, where speakers within a conversation took turns speak-
ing (see Fig. 2). In such a task, there are naively 2D pos-
sible states (here, 65536). However, due to the conversa-
tional grouping, if at most one speaker in a conversation is
speaking at any given time, the state space is constrained,
with only (cid:81)
c(sc + 1) states possible, where sc is the num-
ber of speakers in conversation c (in this case sc ≡ 4, for a
total of 625 possible states).

Each “turn” within a conversation consisted of a single
sentence (average duration ∼ 3s) and turn orders within
a conversation were randomly generated, with random
pauses distributed as N (1/4s, (1/4s)2) inserted between
sentences. Every time a speaker has a turn, the sentence
is drawn randomly from the 500 sentences uttered by that
speaker in the data. The conversations continued for 40s,
and the signal was down-sampled to length 2000. The ’on’
portions of each speaker’s signal were normalized to have
amplitudes with mean 1 and standard deviation 0.5. An ad-
ditional column of 1s was added to the speaker signal ma-
trix, θ∗, representing background noise. The resulting sig-
nal matrix, denoted θ∗, was thus 2000 × 17 and the weight
matrix, W, was 17 × 12. Following Gael et al. (2009) and
Valera et al. (2015), the weights were drawn independently
from a Unif(0, 1) distribution, and independent N (0, 0.32)
noise was added to each entry of the observation matrix.

The Model The latent states, θj, are the D-dimensional
binary vectors whose dth entry indicates whether or not
speaker d is speaking. The locations (cid:96)j are identiﬁed with
the binary vectors, (cid:96)j := θj. We use a Laplacian simi-
larity function on Hamming distance, d0, so that φjj(cid:48) :=
exp(−λd0((cid:96)j, (cid:96)j(cid:48))), λ ≥ 0. The emission model is linear-
Gaussian as in the data, with (D + 1) × K weight matrix
W, and T × (D + 1) signal matrix θ∗ whose tth row is
θt := (1, θzt ), so that yt | z ∼ N (WTθ∗
t , Σ). For the ex-
periments discussed here, we assume that Σ is independent
of j, but this assumption is easily relaxed if appropriate.

For ﬁnite-length binary vector states, the set of possible
states is ﬁnite, and so it may seem that a nonparametric
model is unnecessary. However, if D is reasonably large,
likely most of the 2D possible states are vanishingly un-
likely (and the number of observations may well be less
than 2D), and so we would like to encourage the selection
of a sparse set of states. Moreover, there could be more
than one state with the same emission parameters, but with
different transition dynamics. Next we describe the addi-
tional inference steps needed for this version of the model.

Sampling θ / (cid:96) Since θj and (cid:96)j are identiﬁed, inﬂuencing
both the transition matrix and the emission distributions,

both the state sequence z and the observation matrix Y are
used in the update. We put independent Beta-Bernoulli pri-
ors on each coordinate of θ, and Gibbs sample each coor-
dinate θjd conditioned on all the others and the coordinate-
wise prior means, {µd}, which we sample in turn condi-
tioned on θ. Details are in the supplement.

Sampling λ The λ parameter of the similarity function
governs the connection between (cid:96) and φ. Substituting the
deﬁnition of φ into (13) yields

p(z, Q | (cid:96), λ) ∝

e−λdjj(cid:48) njj(cid:48) (1 − e−λdjj(cid:48) )qjj(cid:48)

(22)

(cid:89)

(cid:89)

j

j(cid:48)

We put an Exp(bλ) prior on λ, which yields a posterior
density

p(λ | z, Q, (cid:96)) ∝ e−(bλ+(cid:80)
(cid:89)

j

(cid:89)

(cid:80)

j(cid:48) djj(cid:48) njj(cid:48) )λ

(23)

×

(1 − e−λdjj(cid:48) )qjj(cid:48)

j

j(cid:48)

This density is log-concave, and so we use Adaptive Rejec-
tion Sampling (Gilks & Wild, 1992) to sample from it.

Sampling W and Σ Conditioned on Y and θ∗, W and
Σ can be sampled as in Bayesian linear regression.
If
each column of W has a multivariate Normal prior, then
the columns are a posteriori independent multivariate Nor-
mals. For the experiments reported here, we ﬁx W to its
ground truth value so that θ∗ can be compared directly with
the ground truth signal matrix, and we constrain Σ to be
diagonal, with Inverse Gamma priors on the variances, re-
sulting in conjugate updates.

Results We attempted to infer the binary speaker matri-
ces using ﬁve models: (1) a binary-state Factorial HMM
(Ghahramani et al., 1997), where individual binary speaker
sequences are modeled as independent, (2) an ordinary
HDP-HMM without local transitions (Teh et al., 2006),
where the latent states are binary vectors, (3) a Sticky HDP-
HMM (Fox et al., 2008), (4) our HDP-HMM-LT model,
and (5) a model that combines the Sticky and LT proper-
ties3. For all models, all concentration and noise preci-
sion parameters are given Gamma(0.1, 0.1) priors. For the
κ
α+κ is given a Unif(0, 1) prior.
Sticky models, the ratio
We evaluated the models at each iteration using both the
Hamming distance between inferred and ground truth state
matrices and F1 score. We also plot the inferred decay rate
λ, and the number of states used by the LT and Sticky-LT
models. The results for the ﬁve models are in Fig. 1. In

3We attempted to add a comparison to the DILN-HMM (Zhu
et al., 2016) as well, but code could not be obtained, and the paper
did not provide enough detail to reproduce their inference algo-
rithm.

An Inﬁnite HMM With Similarity-Biased Transitions

Figure 1. Top: F1 score for inferred relative to ground truth bi-
nary speaker matrices on cocktail party data, evaluated every 50th
Gibbs iteration after the ﬁrst 2000, aggregating across 5 runs of
each model. Middle: Inferred λ, for the LT and Sticky-LT mod-
els by Gibbs iteration, averaged over 5 runs. Bottom: Number of
states used, n·, by each model in the training set. Error bands are
99% conﬁdence interval of the mean per iteration.

Fig. 2, we plot the ground truth state matrix against the av-
erage state matrix, η∗, averaged over runs and post-burn-in
iterations.

The LT and Sticky-LT models outperform the others, while
the regular Sticky model exhibits only a small advantage
over the vanilla HDP-HMM. Both converge on a non-
negligible λ value of about 1.6 (see Fig. 1), suggesting that
the local transition structure explains the data well. The
LT models also use more states than the non-LT models,
perhaps owing to the fact that the weaker transition prior
of the non-LT model is more likely to explain nearby simi-
lar observations as a single persisting state, whereas the LT
model places a higher probability on transitioning to a new
state with a similar latent vector.

4.2. Synthetic Data Without Local Transitions

We generated data directly from the ordinary HDP-HMM
used in the cocktail experiment as a sanity check, to exam-
ine the performance of the LT model in the absence of a
similarity bias. The results are in Fig. 3. When the λ pa-
rameter is large, the LT model has worse performance than
the non-LT model on this data; however, the λ parameter
settles near zero as the model learns that local transitions
are not more probable. When λ = 0, the HDP-HMM-LT is
an ordinary HDP-HMM. The LT model does not make en-
tirely the same inferences as the non-LT model, however; in
particular, the α concentration parameter is larger. To some
extent, α and λ trade off: sparsity of the transition matrix
can be achieved either by beginning with a sparse rate ma-
trix prior to rescaling (α small), or by beginning with a less
sparse rate matrix which becomes sparser through rescaling

Figure 2. Binary speaker matrices for the cocktail data, with time
on the horizontal axis and speaker on the vertical axis. White
is 1, black is 0. The ground truth matrix is at the top, fol-
lowed by the inferred speaker matrix for the Sticky HDP-HMM-
LT, HDP-HMM-LT, binary factorial, Sticky-HDP-HMM, and
“vanilla” HDP-HMM. All inferred matrices are averaged over 5
runs of 5000 Gibbs iterations each, with the ﬁrst 2000 iterations
discarded as burn-in.

(larger α and non-zero λ).

4.3. Bach Chorales

To test a version of the HDP-HMM-LT model in which the
components of the latent state governing similarity are un-
related to the emission distributions, we used our model
to do unsupervised “grammar” learning from a corpus of
Bach chorales. The data was a corpus of 217 four-voice
major key chorales by J.S. Bach from music214, 200 of
which were randomly selected as a training set, with the
other 17 used as a test set to evaluate surprisal (marginal
log likelihood per observation) by the trained models. All
chorales were transposed to C-major, and each distinct
four-voice chord (with voices ordered) was encoded as a
single integer. In total there were 3307 distinct chord types
and 20401 chord tokens in the 217 chorales, with 3165
types and 18818 tokens in the 200 training chorales, and
143 chord types that were unique to the test set.

Modiﬁcations to Model and Inference Since the chords
were encoded as integers, the emission distribution for each
state is Cat(θj). We use a symmetric Dirichlet prior for
each θj, resulting in conjugate updates to θ conditioned on
the latent state sequence, z.

In this experiment, the locations, (cid:96)j, are independent of the
θj, with N (0, I) priors. We use a Gaussian similarity func-
tion, φjj := exp{−λd2((cid:96)j, (cid:96)j(cid:48))2} where d2 is Euclidean
distance. Since the latent states are continuous, we use

4http://web.mit.edu/music21

010200.50.60.70.8F1_scoredensitymodelBFactLTnoLTStickyStickyLTllllllllllllllllllllllll0.51.01.52.010002000300040005000IterationslambdamodellLTStickyLT0.000.050.100.15255075100125n_dotdensitymodelLTnoLTStickyStickyLTGroundtruthStickyLTLTBFactStickynoLTAn Inﬁnite HMM With Similarity-Biased Transitions

Figure 3. Top: F1 score for inferred relative to ground truth bi-
nary speaker matrices on synthetic data generated from the vanilla
HDP-HMM model. Middle: Learned similarity parameter, λ, for
the LT model by Gibbs iteration, averaged over 5 runs. Bottom:
Number of states used, n·, by each model in the training set. Error
bands are 99% conﬁdence interval of the mean per iteration. The
ﬁrst 100 iterations are omitted.

a Hamiltonian Monte Carlo (HMC) update (Duane et al.,
1987; Neal et al., 2011) to update the (cid:96)j simultaneously,
conditioned on z and π (see the supplement for details).

Results We ran 5 Gibbs chains for 10,000 iterations each
using the HDP-HMM-LT, Sticky-HDP-HMM-LT, HDP-
HMM and Sticky-HDP-HMM models on the 200 training
chorales, which were modeled as conditionally indepen-
dent of one another. We evaluated the marginal log like-
lihood on the 17 test chorales (integrating out z) at every
50th iteration. The training and test log likelihoods are in
Fig. 4. Although the LT model does not achieve as close
a ﬁt to the training data, its generalization performance is
better, suggesting that the vanilla HDP-HMM is overﬁt-
ting. This is perhaps counterintuitive, since the LT model
is more ﬂexible, and might be expected to be more prone
to overﬁtting. However, the similarity bias induces greater
information sharing across parameters, as in a hierarchical
model: instead of each entry of the transition matrix be-
ing informed mainly by transitions directly involving the
corresponding states, it is informed to some extent by all
transitions, as they all inform the similarity structure.

5. Discussion

We have deﬁned a new probabilistic model, the Hierar-
chical Dirichlet Process Hidden Markov Model with Lo-
cal Transitions (HDP-HMM-LT), which generalizes the
HDP-HMM by allowing state space geometry to be repre-
sented via a similarity kernel, making transitions between
“nearby” pairs of states (“local” transitions), more likely a
priori. By introducing an augmented data representation,

Figure 4. Training set and test set log marginal likelihoods for
Bach chorale data on the four HDP-based models: HDP-HMM-
LT, HDP-HMM, Sticky HMM, and Sticky HDP-HMM-LT.

which we call the Markov Jump Process with Failed Tran-
sitions (MJP-FT), we obtain a Gibbs sampling algorithm
that simpliﬁes inference in both the LT and ordinary HDP-
HMM. When multiple latent chains are interdependent, as
in speaker diarization, the HDP-HMM-LT model combines
the HDP-HMM’s capacity to discover a small set of joint
states with the Factorial HMM’s ability to encode the prop-
erty that most transitions involve a small number of chains.
The HDP-HMM-LT outperforms both, as well as outper-
forming the Sticky-HDP-HMM, on a speaker diarization
task in which speakers form conversational groups. Despite
the addition of the similarity kernel, the HDP-HMM-LT is
able to suppress its local transition prior when the data does
not support it, achieving identical performance to the HDP-
HMM on data generated directly from the latter.

The local transition property is particularly clear when
transitions occur at different times for different latent fea-
tures, as with binary vector-valued states in the cocktail
party setting, but the model can be used with any state
space equipped with a suitable similarity kernel. Similar-
ities need not be deﬁned in terms of emission parameters;
state “locations” can be represented and inferred separately,
which we demonstrate using Bach chorale data. There,
the LT model achieves better predictive performance on a
held-out test set, while the ordinary HDP-HMM overﬁts
the training set: the LT property here acts to encourage a
concise harmonic representation where chord contexts are
arranged in bidirectional functional relationships.

We focused on ﬁxed-dimension binary vectors for the cock-
tail party and synthetic data experiments, but it would be
straightforward to add the LT property to a model with non-
parametric latent states, such as the iFHMM (Gael et al.,
2009) and the inﬁnite factorial dynamic model (Valera
et al., 2015), both of which use the Indian Buffet Process
(IBP) (Ghahramani & Grifﬁths, 2005) as a state prior. The
similarity function used here could be employed without
changes: since only ﬁnitely many coordinates are non-zero
in the IBP, the distance between any two states is ﬁnite.

llllllllllllllllllll0.60.70.80.91.0500100015002000IterationsF1_scoremodellBFactLTnoLTllllllllllllllllllll−404812500100015002000IterationslambdamodellLT0.000.050.10010203040n_dotdensitymodelLTnoLT0246−5.2−5.0−4.8−4.6−4.4train_log_likelihooddensitymodelLTnoLTStickyStickyLT0.00.51.01.5−15−14−13−12−11test_log_likelihooddensitymodelLTnoLTStickyStickyLTAn Inﬁnite HMM With Similarity-Biased Transitions

Johnson, Matthew J and Willsky, Alan S. Bayesian non-
parametric hidden semi-Markov models. The Journal of
Machine Learning Research, 14(1):673–701, 2013.

Kingman, John. Completely random measures. Paciﬁc

Journal of Mathematics, 21(1):59–78, 1967.

Neal, Radford M et al. MCMC using Hamiltonian dynam-
ics. Handbook of Markov Chain Monte Carlo, 2:113–
162, 2011.

Paisley, John, Wang, Chong, and Blei, David M. The dis-
crete inﬁnite logistic normal distribution. Bayesian Anal-
ysis, 7(4):997–1034, 2012.

Ranganath, Rajesh and Blei, David M. Correlated random
measures. Journal of the American Statistical Associa-
tion, 2016.

Sethuraman, Jayaram. A constructive deﬁnition of Dirich-

let processes. Statistica Sinica, 4:639–650, 1994.

Teh, Yee Whye, Jordan, Michael I, Beal, Matthew J, and
Blei, David M. Hierarchical Dirichlet processes. Journal
of the American Statistical Association, 101(476), 2006.

Valera, Isabel, Ruiz, Francisco, Svensson, Lennart, and
Perez-Cruz, Fernando.
Inﬁnite factorial dynamical
model. In Advances in Neural Information Processing
Systems, pp. 1657–1665, 2015.

Van Gael, Jurgen, Saatci, Yunus, Teh, Yee Whye, and
Ghahramani, Zoubin. Beam sampling for the inﬁnite
In Proceedings of the 25th In-
hidden Markov model.
ternational Conference on Machine Learning, pp. 1088–
1095. ACM, 2008.

Zhu, Hao, Hu, Jinsong, and Leung, Henry. Hidden Markov
models with discrete inﬁnite logistic normal distribution
priors. In Information Fusion (FUSION), 2016 19th In-
ternational Conference on, pp. 429–433. IEEE, 2016.

ACKNOWLEDGMENTS

This work was funded in part by DARPA grant W911NF-
14-1-0395 under the Big Mechanism Program and DARPA
grant W911NF-16-1-0567 under the Communicating with
Computers Program.

References

Beal, Matthew J, Ghahramani, Zoubin, and Rasmussen,
Carl E. The inﬁnite hidden Markov model. In Advances
in neural information processing systems, pp. 577–584,
2001.

Duane, Simon, Kennedy, Anthony D, Pendleton, Brian J,
and Roweth, Duncan. Hybrid monte carlo. Physics let-
ters B, 195(2):216–222, 1987.

Ewens, Warren John. Population genetics theory – the past
and the future. In Mathematical and Statistical Devel-
opments of Evolutionary Theory, pp. 177–227. Springer,
1990.

Favaro, Stefano, Teh, Yee Whye, et al. MCMC for normal-
ized random measure mixture models. Statistical Sci-
ence, 28(3):335–359, 2013.

Ferguson, Thomas S. A Bayesian analysis of some non-
parametric problems. The annals of statistics, pp. 209–
230, 1973.

Fox, Emily B, Sudderth, Erik B, Jordan, Michael I, and
Willsky, Alan S. An HDP-HMM for systems with state
In Proceedings of the 25th international
persistence.
conference on Machine learning, pp. 312–319. ACM,
2008.

Gael, Jurgen V, Teh, Yee W, and Ghahramani, Zoubin. The
inﬁnite factorial hidden Markov model. In Advances in
Neural Information Processing Systems, pp. 1697–1704,
2009.

Ghahramani, Zoubin and Grifﬁths, Thomas L. Inﬁnite la-
tent feature models and the Indian buffet process.
In
Advances in neural information processing systems, pp.
475–482, 2005.

Ghahramani, Zoubin, Jordan, Michael I, and Smyth,
Padhraic. Factorial hidden Markov models. Machine
learning, 29(2-3):245–273, 1997.

Gilks, Walter R and Wild, Pascal. Adaptive rejection sam-
pling for Gibbs sampling. Applied Statistics, pp. 337–
348, 1992.

Ishwaran, Hemant and Zarepour, Mahmoud. Exact and ap-
proximate sum representations for the Dirichlet process.
Canadian Journal of Statistics, 30(2):269–283, 2002.

